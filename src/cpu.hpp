// #include <bits/stdc++.h>
#include "ppu.hpp"
#include "pad.hpp"
// #include "opecodeList.hpp"
// #include <stdint.h>
#include <vector>
#include <map>
#include <string>
#include <iostream>
#include <cstring>

using namespace std;

struct cpustatus
{
    bool Negative;
    bool Overflow;
    bool Resersved;
    bool Break;
    bool Decimal;
    bool Interrupt;
    bool Zero;
    bool Carry;
};

struct Registers
{
    uint8_t A;   //アキュムレータ
    uint8_t X;   //インデックスレジスタ
    uint8_t Y;   //インデックスレジスタ
    uint16_t S;  //スタックポインタ
    cpustatus P; // ステータスレジスタ
    uint16_t PC; //プログラムカウンタ
};

enum addressingMode
{
    zeroPage,
    relative,
    implied,
    absolute,
    accumulator,
    immediate,
    zeroPageX,
    zeroPageY,
    absoluteX,
    absoluteY,
    preIndexedIndirect,  //indexed indirectaddressing
    postIndexedIndirect, //indirect indexed addressing
    indirectAbsolute
};

enum baseName
{
    LDA,
    LDX,
    LDY,
    STA,
    STX,
    STY,
    TXA,
    TYA,
    TXS,
    TAY,
    TAX,
    TSX,
    PHP,
    PLP,
    PHA,
    PLA,
    ADC,
    SBC,
    CPX,
    CPY,
    CMP,
    AND,
    EOR,
    ORA,
    BIT,
    ASL,
    LSR,
    ROL,
    ROR,
    INX,
    INY,
    INC,
    DEX,
    DEY,
    DEC,
    CLC,
    CLI,
    CLV,
    SEC,
    SEI,
    NOP,
    BRK,
    JSR,
    JMP,
    RTI,
    RTS,
    BPL,
    BMI,
    BVC,
    BVS,
    BCC,
    BCS,
    BNE,
    BEQ,
    SED,
    CLD
};

struct opecodestructure
{
    baseName basename;
    addressingMode mode;
    uint8_t cycle;
};

static const vector<uint8_t> cycles =
    {/*00x0*/ 7, 6, 2, 8, 3, 3, 5, 5, 3, 2, 2, 2, 4, 4, 6, 6,
     /*0x10*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 6, 7,
     /*0x20*/ 6, 6, 2, 8, 3, 3, 5, 5, 4, 2, 2, 2, 4, 4, 6, 6,
     /*0x30*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 6, 7,
     /*0x40*/ 6, 6, 2, 8, 3, 3, 5, 5, 3, 2, 2, 2, 3, 4, 6, 6,
     /*0x50*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 6, 7,
     /*0x60*/ 6, 6, 2, 8, 3, 3, 5, 5, 4, 2, 2, 2, 5, 4, 6, 6,
     /*0x70*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 6, 7,
     /*0x80*/ 2, 6, 2, 6, 3, 3, 3, 3, 2, 2, 2, 2, 4, 4, 4, 4,
     /*0x90*/ 2, 6, 2, 6, 4, 4, 4, 4, 2, 4, 2, 5, 5, 4, 5, 5,
     /*0xA0*/ 2, 6, 2, 6, 3, 3, 3, 3, 2, 2, 2, 2, 4, 4, 4, 4,
     /*0xB0*/ 2, 5, 2, 5, 4, 4, 4, 4, 2, 4, 2, 4, 4, 4, 4, 4,
     /*0xC0*/ 2, 6, 2, 8, 3, 3, 5, 5, 2, 2, 2, 2, 4, 4, 6, 6,
     /*0xD0*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 7, 7,
     /*0xE0*/ 2, 6, 3, 8, 3, 3, 5, 5, 2, 2, 2, 2, 4, 4, 6, 6,
     /*0xF0*/ 2, 5, 2, 8, 4, 4, 6, 6, 2, 4, 2, 7, 4, 4, 7, 7};

static map<uint8_t, opecodestructure> opecodeList = {
    {0xA9, {LDA, immediate, cycles[0xA9]}},
    {0xA5, {LDA, zeroPage, cycles[0xA5]}},
    {0xAD, {LDA, absolute, cycles[0xAD]}},
    {0xB5, {LDA, zeroPageX, cycles[0xB5]}},
    {0xBD, {LDA, absoluteX, cycles[0xBD]}},
    {0xB9, {LDA, absoluteY, cycles[0xB9]}},
    {0xA1, {LDA, preIndexedIndirect, cycles[0xA1]}},
    {0xB1, {LDA, postIndexedIndirect, cycles[0xB1]}},
    {0xA2, {LDX, immediate, cycles[0xA2]}},
    {0xA6, {LDX, zeroPage, cycles[0xA6]}},
    {0xAE, {LDX, absolute, cycles[0xAE]}},
    {0xB6, {LDX, zeroPageY, cycles[0xB6]}},
    {0xBE, {LDX, absoluteY, cycles[0xBE]}},
    {0xA0, {LDY, immediate, cycles[0xA0]}},
    {0xA4, {LDY, zeroPage, cycles[0xA4]}},
    {0xAC, {LDY, absolute, cycles[0xAC]}},
    {0xB4, {LDY, zeroPageX, cycles[0xB4]}},
    {0xBC, {LDY, absoluteX, cycles[0xBC]}},
    {0x85, {STA, zeroPage, cycles[0x85]}},
    {0x8D, {STA, absolute, cycles[0x8D]}},
    {0x95, {STA, zeroPageX, cycles[0x95]}},
    {0x9D, {STA, absoluteX, cycles[0x9D]}},
    {0x99, {STA, absoluteY, cycles[0x99]}},
    {0x81, {STA, preIndexedIndirect, cycles[0x81]}},
    {0x91, {STA, postIndexedIndirect, cycles[0x91]}},
    {0x86, {STX, zeroPage, cycles[0x86]}},
    {0x8E, {STX, absolute, cycles[0x8E]}},
    {0x96, {STX, zeroPageY, cycles[0x96]}},
    {0x84, {STY, zeroPage, cycles[0x84]}},
    {0x8C, {STY, absolute, cycles[0x8C]}},
    {0x94, {STY, zeroPageX, cycles[0x94]}},
    {0x8A, {TXA, implied, cycles[0x8A]}},
    {0x98, {TYA, implied, cycles[0x98]}},
    {0x9A, {TXS, implied, cycles[0x9A]}},
    {0xA8, {TAY, implied, cycles[0xA8]}},
    {0xAA, {TAX, implied, cycles[0xAA]}},
    {0xBA, {TSX, implied, cycles[0xBA]}},
    {0x08, {PHP, implied, cycles[0x08]}},
    {0x28, {PLP, implied, cycles[0x28]}},
    {0x48, {PHA, implied, cycles[0x48]}},
    {0x68, {PLA, implied, cycles[0x68]}},
    {0x69, {ADC, immediate, cycles[0x69]}},
    {0x65, {ADC, zeroPage, cycles[0x65]}},
    {0x6D, {ADC, absolute, cycles[0x6D]}},
    {0x75, {ADC, zeroPageX, cycles[0x75]}},
    {0x7D, {ADC, absoluteX, cycles[0x7D]}},
    {0x79, {ADC, absoluteY, cycles[0x79]}},
    {0x61, {ADC, preIndexedIndirect, cycles[0x61]}},
    {0x71, {ADC, postIndexedIndirect, cycles[0x71]}},
    {0xE9, {SBC, immediate, cycles[0xE9]}},
    {0xE5, {SBC, zeroPage, cycles[0xE5]}},
    {0xED, {SBC, absolute, cycles[0xED]}},
    {0xF5, {SBC, zeroPageX, cycles[0xF5]}},
    {0xFD, {SBC, absoluteX, cycles[0xFD]}},
    {0xF9, {SBC, absoluteY, cycles[0xF9]}},
    {0xE1, {SBC, preIndexedIndirect, cycles[0xE1]}},
    {0xF1, {SBC, postIndexedIndirect, cycles[0xF1]}},
    {0xE0, {CPX, immediate, cycles[0xE0]}},
    {0xE4, {CPX, zeroPage, cycles[0xE4]}},
    {0xEC, {CPX, absolute, cycles[0xEC]}},
    {0xC0, {CPY, immediate, cycles[0xC0]}},
    {0xC4, {CPY, zeroPage, cycles[0xC4]}},
    {0xCC, {CPY, absolute, cycles[0xCC]}},
    {0xC9, {CMP, immediate, cycles[0xC9]}},
    {0xC5, {CMP, zeroPage, cycles[0xC5]}},
    {0xCD, {CMP, absolute, cycles[0xCD]}},
    {0xD5, {CMP, zeroPageX, cycles[0xD5]}},
    {0xDD, {CMP, absoluteX, cycles[0xDD]}},
    {0xD9, {CMP, absoluteY, cycles[0xD9]}},
    {0xC1, {CMP, preIndexedIndirect, cycles[0xC1]}},
    {0xD1, {CMP, postIndexedIndirect, cycles[0xD1]}},
    {0x29, {AND, immediate, cycles[0x29]}},
    {0x25, {AND, zeroPage, cycles[0x25]}},
    {0x2D, {AND, absolute, cycles[0x2D]}},
    {0x35, {AND, zeroPageX, cycles[0x35]}},
    {0x3D, {AND, absoluteX, cycles[0x3D]}},
    {0x39, {AND, absoluteY, cycles[0x39]}},
    {0x21, {AND, preIndexedIndirect, cycles[0x21]}},
    {0x31, {AND, postIndexedIndirect, cycles[0x31]}},
    {0x49, {EOR, immediate, cycles[0x49]}},
    {0x45, {EOR, zeroPage, cycles[0x45]}},
    {0x4D, {EOR, absolute, cycles[0x4D]}},
    {0x55, {EOR, zeroPageX, cycles[0x55]}},
    {0x5D, {EOR, absoluteX, cycles[0x5D]}},
    {0x59, {EOR, absoluteY, cycles[0x59]}},
    {0x41, {EOR, preIndexedIndirect, cycles[0x41]}},
    {0x51, {EOR, postIndexedIndirect, cycles[0x51]}},
    {0x09, {ORA, immediate, cycles[0x09]}},
    {0x05, {ORA, zeroPage, cycles[0x05]}},
    {0x0D, {ORA, absolute, cycles[0x0D]}},
    {0x15, {ORA, zeroPageX, cycles[0x15]}},
    {0x1D, {ORA, absoluteX, cycles[0x1D]}},
    {0x19, {ORA, absoluteY, cycles[0x19]}},
    {0x01, {ORA, preIndexedIndirect, cycles[0x01]}},
    {0x11, {ORA, postIndexedIndirect, cycles[0x11]}},
    {0x24, {BIT, zeroPage, cycles[0x24]}},
    {0x2C, {BIT, absolute, cycles[0x2C]}},
    {0x0A, {ASL, accumulator, cycles[0x0A]}},
    {0x06, {ASL, zeroPage, cycles[0x06]}},
    {0x0E, {ASL, absolute, cycles[0x0E]}},
    {0x16, {ASL, zeroPageX, cycles[0x16]}},
    {0x1E, {ASL, absoluteX, cycles[0x1E]}},
    {0x4A, {LSR, accumulator, cycles[0x4A]}},
    {0x46, {LSR, zeroPage, cycles[0x46]}},
    {0x4E, {LSR, absolute, cycles[0x4E]}},
    {0x56, {LSR, zeroPageX, cycles[0x56]}},
    {0x5E, {LSR, absoluteX, cycles[0x5E]}},
    {0x2A, {ROL, accumulator, cycles[0x2A]}},
    {0x26, {ROL, zeroPage, cycles[0x26]}},
    {0x2E, {ROL, absolute, cycles[0x2E]}},
    {0x36, {ROL, zeroPageX, cycles[0x36]}},
    {0x3E, {ROL, absoluteX, cycles[0x3E]}},
    {0x6A, {ROR, accumulator, cycles[0x6A]}},
    {0x66, {ROR, zeroPage, cycles[0x66]}},
    {0x6E, {ROR, absolute, cycles[0x6E]}},
    {0x76, {ROR, zeroPageX, cycles[0x76]}},
    {0x7E, {ROR, absoluteX, cycles[0x7E]}},
    {0xE8, {INX, implied, cycles[0xE8]}},
    {0xC8, {INY, implied, cycles[0xC8]}},
    {0xE6, {INC, zeroPage, cycles[0xE6]}},
    {0xEE, {INC, absolute, cycles[0xEE]}},
    {0xF6, {INC, zeroPageX, cycles[0xF6]}},
    {0xFE, {INC, absoluteX, cycles[0xFE]}},
    {0xCA, {DEX, implied, cycles[0xCA]}},
    {0x88, {DEY, implied, cycles[0x88]}},
    {0xC6, {DEC, zeroPage, cycles[0xC6]}},
    {0xCE, {DEC, absolute, cycles[0xCE]}},
    {0xD6, {DEC, zeroPageX, cycles[0xD6]}},
    {0xDE, {DEC, absoluteX, cycles[0xDE]}},
    {0x18, {CLC, implied, cycles[0x18]}},
    {0x58, {CLI, implied, cycles[0x58]}},
    {0xB8, {CLV, implied, cycles[0xB8]}},
    {0x38, {SEC, implied, cycles[0x38]}},
    {0x78, {SEI, implied, cycles[0x78]}},
    {0xEA, {NOP, implied, cycles[0xEA]}},
    {0x00, {BRK, implied, cycles[0x00]}},
    {0x20, {JSR, absolute, cycles[0x20]}},
    {0x4C, {JMP, absolute, cycles[0x4C]}},
    {0x6C, {JMP, indirectAbsolute, cycles[0x6C]}},
    {0x40, {RTI, implied, cycles[0x40]}},
    {0x60, {RTS, implied, cycles[0x60]}},
    {0x10, {BPL, relative, cycles[0x10]}},
    {0x30, {BMI, relative, cycles[0x30]}},
    {0x50, {BVC, relative, cycles[0x50]}},
    {0x70, {BVS, relative, cycles[0x70]}},
    {0x90, {BCC, relative, cycles[0x90]}},
    {0xB0, {BCS, relative, cycles[0xB0]}},
    {0xD0, {BNE, relative, cycles[0xD0]}},
    {0xF0, {BEQ, relative, cycles[0xF0]}},
    {0xF8, {SED, implied, cycles[0xF8]}},
    {0xD8, {CLD, implied, cycles[0xD8]}}};

static map<uint8_t, string> dictionary = {
    {0xA9, "LDA_IMM"},
    {0xA5, "LDA_ZERO"},
    {0xAD, "LDA_ABS"},
    {0xB5, "LDA_ZEROX"},
    {0xBD, "LDA_ABSX"},
    {0xB9, "LDA_ABSY"},
    {0xA1, "LDA_INDX"},
    {0xB1, "LDA_INDY"},
    {0xA2, "LDX_IMM"},
    {0xA6, "LDX_ZERO"},
    {0xAE, "LDX_ABS"},
    {0xB6, "LDX_ZEROY"},
    {0xBE, "LDX_ABSY"},
    {0xA0, "LDY_IMM"},
    {0xA4, "LDY_ZERO"},
    {0xAC, "LDY_ABS"},
    {0xB4, "LDY_ZEROX"},
    {0xBC, "LDY_ABSX"},
    {0x85, "STA_ZERO"},
    {0x8D, "STA_ABS"},
    {0x95, "STA_ZEROX"},
    {0x9D, "STA_ABSX"},
    {0x99, "STA_ABSY"},
    {0x81, "STA_INDX"},
    {0x91, "STA_INDY"},
    {0x86, "STX_ZERO"},
    {0x8E, "STX_ABS"},
    {0x96, "STX_ZEROY"},
    {0x84, "STY_ZERO"},
    {0x8C, "STY_ABS"},
    {0x94, "STY_ZEROX"},
    {0x8A, "TXA"},
    {0x98, "TYA"},
    {0x9A, "TXS"},
    {0xA8, "TAY"},
    {0xAA, "TAX"},
    {0xBA, "TSX"},
    {0x08, "PHP"},
    {0x28, "PLP"},
    {0x48, "PHA"},
    {0x68, "PLA"},
    {0x69, "ADC_IMM"},
    {0x65, "ADC_ZERO"},
    {0x6D, "ADC_ABS"},
    {0x75, "ADC_ZEROX"},
    {0x7D, "ADC_ABSX"},
    {0x79, "ADC_ABSY"},
    {0x61, "ADC_INDX"},
    {0x71, "ADC_INDY"},
    {0xE9, "SBC_IMM"},
    {0xE5, "SBC_ZERO"},
    {0xED, "SBC_ABS"},
    {0xF5, "SBC_ZEROX"},
    {0xFD, "SBC_ABSX"},
    {0xF9, "SBC_ABSY"},
    {0xE1, "SBC_INDX"},
    {0xF1, "SBC_INDY"},
    {0xE0, "CPX_IMM"},
    {0xE4, "CPX_ZERO"},
    {0xEC, "CPX_ABS"},
    {0xC0, "CPY_IMM"},
    {0xC4, "CPY_ZERO"},
    {0xCC, "CPY_ABS"},
    {0xC9, "CMP_IMM"},
    {0xC5, "CMP_ZERO"},
    {0xCD, "CMP_ABS"},
    {0xD5, "CMP_ZEROX"},
    {0xDD, "CMP_ABSX"},
    {0xD9, "CMP_ABSY"},
    {0xC1, "CMP_INDX"},
    {0xD1, "CMP_INDY"},
    {0x29, "AND_IMM"},
    {0x25, "AND_ZERO"},
    {0x2D, "AND_ABS"},
    {0x35, "AND_ZEROX"},
    {0x3D, "AND_ABSX"},
    {0x39, "AND_ABSY"},
    {0x21, "AND_INDX"},
    {0x31, "AND_INDY"},
    {0x49, "EOR_IMM"},
    {0x45, "EOR_ZERO"},
    {0x4D, "EOR_ABS"},
    {0x55, "EOR_ZEROX"},
    {0x5D, "EOR_ABSX"},
    {0x59, "EOR_ABSY"},
    {0x41, "EOR_INDX"},
    {0x51, "EOR_INDY"},
    {0x09, "ORA_IMM"},
    {0x05, "ORA_ZERO"},
    {0x0D, "ORA_ABS"},
    {0x15, "ORA_ZEROX"},
    {0x1D, "ORA_ABSX"},
    {0x19, "ORA_ABSY"},
    {0x01, "ORA_INDX"},
    {0x11, "ORA_INDY"},
    {0x24, "BIT_ZERO"},
    {0x2C, "BIT_ABS"},
    {0x0A, "ASL"},
    {0x06, "ASL_ZERO"},
    {0x0E, "ASL_ABS"},
    {0x16, "ASL_ZEROX"},
    {0x1E, "ASL_ABSX"},
    {0x4A, "LSR"},
    {0x46, "LSR_ZERO"},
    {0x4E, "LSR_ABS"},
    {0x56, "LSR_ZEROX"},
    {0x5E, "LSR_ABSX"},
    {0x2A, "ROL"},
    {0x26, "ROL_ZERO"},
    {0x2E, "ROL_ABS"},
    {0x36, "ROL_ZEROX"},
    {0x3E, "ROL_ABSX"},
    {0x6A, "ROR"},
    {0x66, "ROR_ZERO"},
    {0x6E, "ROR_ABS"},
    {0x76, "ROR_ZEROX"},
    {0x7E, "ROR_ABSX"},
    {0xE8, "INX"},
    {0xC8, "INY"},
    {0xE6, "INC_ZERO"},
    {0xEE, "INC_ABS"},
    {0xF6, "INC_ZEROX"},
    {0xFE, "INC_ABSX"},
    {0xCA, "DEX"},
    {0x88, "DEY"},
    {0xC6, "DEC_ZERO"},
    {0xCE, "DEC_ABS"},
    {0xD6, "DEC_ZEROX"},
    {0xDE, "DEC_ABSX"},
    {0x18, "CLC"},
    {0x58, "CLI"},
    {0xB8, "CLV"},
    {0x38, "SEC"},
    {0x78, "SEI"},
    {0xEA, "NOP"},
    {0x00, "BRK"},
    {0x20, "JSR_ABS"},
    {0x4C, "JMP_ABS"},
    {0x6C, "JMP_INDABS"},
    {0x40, "RTI"},
    {0x60, "RTS"},
    {0x10, "BPL"},
    {0x30, "BMI"},
    {0x50, "BVC"},
    {0x70, "BVS"},
    {0x90, "BCC"},
    {0xB0, "BCS"},
    {0xD0, "BNE"},
    {0xF0, "BEQ"},
    {0xF8, "SED"},
    {0xD8, "CLD"}};

class CPU : public PPU, public pad
{
    Registers CPUregisters;

public:
    CPU();
    uint8_t zipP();
    void unzipP(uint8_t binary_P);
    void reset();
    uint8_t ramread(uint16_t address);
    void ramwrite(uint16_t address, uint8_t data);

    uint8_t fetch();
    uint8_t run();
    uint16_t fetchOpeland(addressingMode mode);
    void exec(baseName &basename, uint16_t opeland, addressingMode &mode);
    void print();
    void NMI();
    void IRQ();
    // operation(uint8_t opecode);
};
